<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Bot ç®¡ç†é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 14px;
            opacity: 0.9;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .section-header h2 {
            margin: 0;
            padding: 0;
            border: none;
        }

        .section-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .collapse-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
            transition: transform 0.3s;
        }

        .collapse-btn:hover {
            background: #f3f4f6;
            border-radius: 5px;
        }

        .collapse-btn.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            max-height: 10000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .sort-select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }

        .sort-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .section-header h2 {
            margin: 0;
            padding: 0;
            border: none;
        }

        .section-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .collapse-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
            transition: transform 0.3s;
        }

        .collapse-btn:hover {
            background: #f3f4f6;
            border-radius: 5px;
        }

        .collapse-btn.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            max-height: 10000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .sort-select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            background: white;
            cursor: pointer;
        }

        .sort-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .feed-list {
            list-style: none;
        }

        .feed-item {
            background: #f9fafb;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .feed-item:hover {
            background: #f3f4f6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .feed-item.expanded {
            background: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .feed-item.error {
            border-left-color: #ef4444;
        }

        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .feed-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .feed-actions {
            display: flex;
            gap: 5px;
        }

        .feed-info {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .feed-url {
            color: #888;
            font-size: 12px;
            word-break: break-all;
        }

        .filter-list {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
        }

        .filter-item {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px 5px 0 0;
            border-radius: 5px;
            font-size: 12px;
        }

        .filter-include {
            background: #d1fae5;
            color: #065f46;
        }

        .filter-exclude {
            background: #fee2e2;
            color: #991b1b;
        }

        .feed-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e5e7eb;
        }

        .feed-details.show {
            display: block;
        }

        .article-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .article-item {
            padding: 8px 12px;
            background: #f9fafb;
            margin-bottom: 5px;
            border-radius: 5px;
            font-size: 13px;
        }

        .article-item .article-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 3px;
        }

        .article-item .article-date {
            color: #888;
            font-size: 11px;
        }

        .detail-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .ai-toggle {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 5px 10px;
            background: #f3f4f6;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .ai-toggle:hover {
            background: #e5e7eb;
        }

        .ai-toggle input[type="checkbox"] {
            cursor: pointer;
        }

        .ai-toggle-label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
            user-select: none;
        }

        .ai-toggle input[type="checkbox"]:checked + .ai-toggle-label {
            color: #10b981;
        }

        .status-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-title {
            font-size: 16px;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.status-configured {
            background: #10b981;
            color: white;
        }

        .status-badge.status-partial {
            background: #f59e0b;
            color: white;
        }

        .status-badge.status-unconfigured {
            background: #ef4444;
            color: white;
        }

        .status-badge.status-unknown {
            background: #6b7280;
            color: white;
        }

        .status-body {
            display: grid;
            gap: 10px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            font-size: 14px;
        }

        .status-label {
            font-weight: 500;
            opacity: 0.9;
        }

        .status-item span:last-child {
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .message {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .message-success {
            background: #d1fae5;
            color: #065f46;
        }

        .message-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ“¡ RSS Bot ç®¡ç†é¢æ¿</h1>
            <div class="stats">
                <div class="stat-card">
                    <div class="value" id="feedCount">-</div>
                    <div class="label">è®¢é˜…æº</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="articleCount">-</div>
                    <div class="label">æ–‡ç« æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="checkInterval">-</div>
                    <div class="label">æ£€æŸ¥é—´éš”(åˆ†é’Ÿ)</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="retentionDays">-</div>
                    <div class="label">ä¿ç•™å¤©æ•°</div>
                </div>
            </div>
        </div>

        <!-- Add Feed Section -->
        <div class="section">
            <h2>â• æ·»åŠ è®¢é˜…æº</h2>
            <div id="addMessage"></div>
            <div class="form-group">
                <label for="feedUrl">RSS è®¢é˜…é“¾æ¥</label>
                <div style="display:flex;gap:10px;">
                    <input type="text" id="feedUrl" placeholder="https://example.com/feed.xml" style="flex:1;">
                    <button class="btn btn-secondary" onclick="previewFeed()" style="white-space:nowrap;">ğŸ” é¢„è§ˆ</button>
                </div>
            </div>
            
            <!-- é¢„è§ˆç»“æœ -->
            <div id="previewResult" style="display:none;margin-bottom:15px;padding:15px;background:#f8f9fa;border-radius:8px;border-left:4px solid #667eea;">
                <div style="font-weight:bold;margin-bottom:10px;color:#333;">ğŸ“° <span id="previewTitle">æ ‡é¢˜</span></div>
                <div style="color:#666;font-size:14px;margin-bottom:10px;">æœ€æ–° <span id="previewCount">0</span> ç¯‡æ–‡ç« ï¼š</div>
                <ul id="previewArticles" style="margin:0;padding-left:20px;max-height:200px;overflow-y:auto;"></ul>
            </div>
            
            <div class="form-group">
                <label for="initMode">åˆå§‹åŒ–æ–¹å¼</label>
                <select id="initMode" onchange="updateInitModeHint()">
                    <option value="record">ä»…è®°å½•æœ€æ–° 10 ç¯‡ï¼ˆä¸æ¨é€ï¼‰</option>
                    <option value="push-1">æ¨é€æœ€æ–° 1 ç¯‡æ–‡ç« </option>
                    <option value="push-3">æ¨é€æœ€æ–° 3 ç¯‡æ–‡ç« </option>
                    <option value="push-5" selected>æ¨é€æœ€æ–° 5 ç¯‡æ–‡ç« </option>
                    <option value="push-10">æ¨é€æœ€æ–° 10 ç¯‡æ–‡ç« </option>
                </select>
                <small id="initModeHint" style="color:#666;margin-top:5px;display:block;">ğŸ’¡ æ¨é€æ¨¡å¼ä¼šç«‹å³å‘é€æœ€æ–°æ–‡ç« åˆ° Telegram</small>
            </div>
            
            <div class="form-group">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="enableAI" style="width:auto;">
                    <span>ğŸ¤– å¯ç”¨ AI æ€»ç»“</span>
                </label>
                <small style="color:#666;margin-top:5px;display:block;">ğŸ’¡ å¼€å¯åï¼Œè¯¥è®¢é˜…æºçš„æ›´æ–°å°†ä¼šè‡ªåŠ¨ç”Ÿæˆ AI æ€»ç»“ï¼ˆéœ€é…ç½® AI API Keyï¼‰</small>
            </div>
            
            <button class="btn btn-primary" onclick="addFeed()">æ·»åŠ è®¢é˜…</button>
        </div>

        <!-- Feeds List -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ“‹ è®¢é˜…æºåˆ—è¡¨</h2>
                <div class="section-controls">
                    <select class="sort-select" id="feedSort" onchange="sortFeeds()">
                        <option value="id-asc">æŒ‰IDå‡åº</option>
                        <option value="id-desc">æŒ‰IDé™åº</option>
                        <option value="title-asc">æŒ‰æ ‡é¢˜A-Z</option>
                        <option value="title-desc">æŒ‰æ ‡é¢˜Z-A</option>
                        <option value="articles-desc">æŒ‰æ–‡ç« æ•°é™åº</option>
                        <option value="articles-asc">æŒ‰æ–‡ç« æ•°å‡åº</option>
                    </select>
                    <button class="collapse-btn" onclick="toggleSection('feeds')" title="æŠ˜å /å±•å¼€">â–¼</button>
                </div>
            </div>
            <div class="section-content" id="feedsContent">
                <div id="feedsLoading" class="loading">åŠ è½½ä¸­...</div>
                <ul id="feedsList" class="feed-list"></ul>
            </div>
        </div>

        <!-- Settings -->
        <div class="section">
            <div class="section-header">
                <h2>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
                <button class="collapse-btn" onclick="toggleSection('settings')" title="æŠ˜å /å±•å¼€">â–¼</button>
            </div>
            <div class="section-content" id="settingsContent">
                <div id="settingsMessage"></div>
                
                <!-- æ•°æ®åº“ä¿¡æ¯å¡ç‰‡ -->
                <div class="status-card" style="margin-bottom: 20px;">
                    <div class="status-header">
                        <span class="status-title">ğŸ’¾ æ•°æ®åº“ä¿¡æ¯</span>
                        <span id="dbStatusBadge" class="status-badge status-success">æ­£å¸¸</span>
                    </div>
                    <div class="status-body">
                        <div class="status-item">
                            <span class="status-label">æ–‡ä»¶è·¯å¾„:</span>
                            <span id="dbPath" style="font-family: monospace; font-size: 12px;">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ–‡ä»¶å¤§å°:</span>
                            <span id="dbSize" style="font-weight: bold; color: #667eea;">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">è®¢é˜…æºæ•°:</span>
                            <span id="dbFeedCount" style="font-weight: bold;">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ–‡ç« æ€»æ•°:</span>
                            <span id="dbArticleCount" style="font-weight: bold;">-</span>
                        </div>
                    </div>
                </div>

                <h3 style="margin-top:20px;margin-bottom:15px;color:#333;font-size:16px;">âš™ï¸ è¿è¡Œå‚æ•°</h3>
                
                <div class="settings-grid">
                    <div class="form-group">
                        <label for="settingInterval">æ£€æŸ¥é—´éš” (åˆ†é’Ÿ)</label>
                        <input type="number" id="settingInterval" min="1" max="1440">
                        <small style="display:block;color:#666;margin-top:5px;">è‡ªåŠ¨æ£€æŸ¥ RSS æ›´æ–°çš„æ—¶é—´é—´éš”</small>
                    </div>
                    <div class="form-group">
                        <label for="settingRetentionDays">ä¿ç•™å¤©æ•°</label>
                        <input type="number" id="settingRetentionDays" min="1" max="365">
                        <small style="display:block;color:#666;margin-top:5px;">è¶…è¿‡æ­¤å¤©æ•°çš„æ–‡ç« å°†è¢«æ¸…ç†</small>
                    </div>
                    <div class="form-group">
                        <label for="settingRetentionCount">æ¯æºä¿ç•™æ–‡ç« æ•°</label>
                        <input type="number" id="settingRetentionCount" min="10" max="10000">
                        <small style="display:block;color:#666;margin-top:5px;">æ¯ä¸ªè®¢é˜…æºæœ€å¤šä¿ç•™çš„æ–‡ç« æ•°é‡</small>
                    </div>
                </div>
                
                <h3 style="margin-top:25px;margin-bottom:15px;color:#333;font-size:16px;">ğŸ› ï¸ æ“ä½œ</h3>
                
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                    <button class="btn btn-primary" onclick="manualCheck()">ğŸ”„ æ‰‹åŠ¨æ£€æŸ¥æ›´æ–°</button>
                    <button class="btn btn-danger" onclick="cleanupByDays()">ğŸ—‘ï¸ æ¸…ç†æ—§æ–‡ç« (æŒ‰å¤©æ•°)</button>
                    <button class="btn btn-danger" onclick="cleanupByCount()">ğŸ—‘ï¸ æ¸…ç†æ—§æ–‡ç« (æŒ‰æ•°é‡)</button>
                </div>
            </div>
        </div>

        <!-- AI æ€»ç»“è®¾ç½® -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ¤– AI æ€»ç»“è®¾ç½®</h2>
                <button class="collapse-btn" onclick="toggleSection('ai')" title="æŠ˜å /å±•å¼€">â–¼</button>
            </div>
            <div class="section-content" id="aiContent">
                <div id="aiMessage"></div>
                
                <!-- å…¨å±€å¼€å…³ -->
                <div class="status-card" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="status-header" style="border-bottom-color: rgba(255,255,255,0.2);">
                        <span class="status-title" style="color: white; font-weight: bold;">ğŸ›ï¸ å…¨å±€å¼€å…³</span>
                    </div>
                    <div class="status-body">
                        <div style="padding: 10px 0;">
                            <label style="display: flex; align-items: center; cursor: pointer; font-size: 16px;">
                                <input type="checkbox" id="aiEnabled" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                                <span style="font-weight: bold;">å¯ç”¨ AI æ€»ç»“åŠŸèƒ½</span>
                            </label>
                            <small style="display:block; color: rgba(255,255,255,0.9); margin-top: 8px; padding-left: 30px; line-height: 1.5;">
                                âœ“ å…¨å±€å¼€å…³å¯ç”¨åï¼Œè¿˜éœ€åœ¨è®¢é˜…æºç®¡ç†ä¸­ä¸ºæ¯ä¸ªæºå•ç‹¬å¼€å¯ AI æ€»ç»“<br>
                                âœ“ å•æ¬¡æ›´æ–°æ–‡ç« æ•°é‡éœ€è¾¾åˆ°æœ€å°‘æ–‡ç« æ•°é‡é˜ˆå€¼æ‰ä¼šè§¦å‘ AI æ€»ç»“
                            </small>
                        </div>
                    </div>
                </div>
            
                <!-- AI é…ç½®çŠ¶æ€ -->
                <div id="aiStatusCard" class="status-card" style="margin-bottom: 20px;">
                    <div class="status-header">
                        <span class="status-title">ğŸ“Š é…ç½®çŠ¶æ€</span>
                        <span id="aiStatusBadge" class="status-badge status-unknown">æœªçŸ¥</span>
                    </div>
                    <div class="status-body">
                        <div class="status-item">
                            <span class="status-label">å…¨å±€å¼€å…³:</span>
                            <span id="aiGlobalStatus">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">AI æä¾›å•†:</span>
                            <span id="aiProviderStatus">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">API Key:</span>
                            <span id="aiKeyStatus">-</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å·²å¯ç”¨æºæ•°:</span>
                            <span id="aiEnabledFeedsCount">-</span>
                        </div>
                    </div>
                </div>

                <h3 style="margin-top:25px;margin-bottom:15px;color:#333;font-size:16px;">âš™ï¸ AI æä¾›å•†é…ç½®</h3>

                <div class="form-group">
                    <label for="aiProvider">AI æä¾›å•†</label>
                    <select id="aiProvider" onchange="onProviderChange()">
                        <option value="gemini">Google Gemini (æ¨èå…è´¹)</option>
                        <option value="deepseek">DeepSeek (æ€§ä»·æ¯”é«˜)</option>
                        <option value="qwen">é€šä¹‰åƒé—® (å›½å†…ç¨³å®š)</option>
                    </select>
                    <small style="display:block;color:#666;margin-top:5px;">
                        ä¸åŒæä¾›å•†çš„ API Key å•ç‹¬ä¿å­˜ï¼Œåˆ‡æ¢æ—¶æ— éœ€é‡æ–°è¾“å…¥
                    </small>
                </div>

                <div class="form-group">
                    <label for="aiApiKey">API Key</label>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <input type="password" id="aiApiKey" placeholder="è¾“å…¥ API Key" style="flex:1;">
                        <button class="btn btn-small" onclick="toggleApiKeyVisibility()" id="toggleKeyBtn" title="æ˜¾ç¤º/éšè—">
                            ğŸ‘ï¸
                        </button>
                        <button class="btn btn-small btn-danger" onclick="clearApiKey()" title="æ¸…é™¤ Key">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                    <small id="aiKeyInfo" style="display:block;color:#666;margin-top:5px;">
                        æœªé…ç½® API Key
                    </small>
                </div>

                <div class="form-group">
                    <label for="aiModel">æ¨¡å‹åç§° (å¯é€‰)</label>
                    <input type="text" id="aiModel" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤æ¨¡å‹">
                    <small id="aiModelHint" style="display:block;color:#666;margin-top:5px;">
                        Gemini: gemini-2.0-flash-exp | DeepSeek: deepseek-chat | åƒé—®: qwen-turbo
                    </small>
                </div>

                <h3 style="margin-top:25px;margin-bottom:15px;color:#333;font-size:16px;">ğŸšï¸ æ€»ç»“å‚æ•°</h3>

                <div class="form-group">
                    <label for="aiMinArticles">æœ€å°‘æ–‡ç« æ•°é‡é˜ˆå€¼</label>
                    <input type="number" id="aiMinArticles" min="1" max="20" placeholder="3">
                    <small style="display:block;color:#666;margin-top:5px;">
                        å•æ¬¡æ›´æ–°æ–‡ç« æ•°é‡ä½äºæ­¤å€¼æ—¶ï¼Œè·³è¿‡ AI æ€»ç»“ç›´æ¥æ¨é€åŸæ–‡ (é»˜è®¤: 3 ç¯‡)
                    </small>
                </div>

                <h3 style="margin-top:25px;margin-bottom:15px;color:#333;font-size:16px;">ğŸ› ï¸ æ“ä½œ</h3>

                <div class="action-buttons" style="gap:10px;">
                    <button class="btn btn-success" onclick="saveAISettings()">ğŸ’¾ ä¿å­˜ AI è®¾ç½®</button>
                    <button class="btn btn-primary" onclick="testAIConnection()" id="testAIBtn">ğŸ”Œ æµ‹è¯•è¿æ¥</button>
                </div>
                
                <!-- API Key è·å–å¸®åŠ© -->
                <div id="apiKeyHelp" style="margin-top:20px;padding:15px;background:#f9fafb;border-radius:8px;border-left:4px solid #667eea;display:none;">
                    <h4 style="margin:0 0 10px 0;color:#333;">ğŸ“– å¦‚ä½•è·å– API Key</h4>
                    <div id="helpContent"></div>
                </div>
                
                <!-- å®‰å…¨æç¤º -->
                <div style="margin-top:20px;padding:15px;background:#fef3c7;border-radius:8px;border-left:4px solid #f59e0b;">
                    <h4 style="margin:0 0 10px 0;color:#92400e;display:flex;align-items:center;">
                        ğŸ”’ å®‰å…¨æç¤º
                    </h4>
                    <ul style="margin:0;padding-left:20px;color:#78350f;line-height:1.8;">
                        <li>API Key å­˜å‚¨åœ¨æœ¬åœ°æ•°æ®åº“æ–‡ä»¶ä¸­ï¼Œè¯·å¦¥å–„ä¿ç®¡</li>
                        <li>Web é¢æ¿ä»…ç›‘å¬æœ¬åœ°åœ°å€ (127.0.0.1)ï¼Œå¤–éƒ¨æ— æ³•è®¿é—®</li>
                        <li>å»ºè®®å®šæœŸåœ¨ AI æä¾›å•†å¤„æ£€æŸ¥ API ä½¿ç”¨æƒ…å†µ</li>
                        <li>å¦‚æ€€ç–‘å¯†é’¥æ³„éœ²ï¼Œè¯·ç«‹å³åœ¨æä¾›å•†å¤„æ’¤é”€å¹¶é‡æ–°ç”Ÿæˆ</li>
                    </ul>
                    <details style="margin-top:10px;">
                        <summary style="cursor:pointer;color:#92400e;font-weight:500;">æŸ¥çœ‹è¯¦ç»†å®‰å…¨è¯´æ˜</summary>
                        <div style="margin-top:10px;padding:10px;background:white;border-radius:4px;font-size:13px;color:#666;">
                            <p style="margin:5px 0;"><strong>å­˜å‚¨ä½ç½®:</strong> data/rss.db (SQLite æ•°æ®åº“)</p>
                            <p style="margin:5px 0;"><strong>ä¼ è¾“å®‰å…¨:</strong> API Key é€šè¿‡ HTTPS å‘é€ç»™ AI æä¾›å•†</p>
                            <p style="margin:5px 0;"><strong>æ˜¾ç¤ºå®‰å…¨:</strong> Web ç•Œé¢æ°¸ä¸æ˜¾ç¤ºå®Œæ•´ Key</p>
                            <p style="margin:5px 0;"><strong>æ—¥å¿—å®‰å…¨:</strong> é”™è¯¯æ—¥å¿—å·²è¿‡æ»¤æ•æ„Ÿä¿¡æ¯</p>
                            <p style="margin:10px 0 5px 0;"><strong>å»ºè®®æªæ–½:</strong></p>
                            <ul style="margin:0;padding-left:20px;">
                                <li>å®šæœŸè½®æ¢ API Key</li>
                                <li>åœ¨ AI æä¾›å•†å¤„è®¾ç½®ä½¿ç”¨é…é¢å’Œè­¦æŠ¥</li>
                                <li>å¤‡ä»½æ•°æ®åº“æ—¶è¿›è¡ŒåŠ å¯†</li>
                                <li>ä¸è¦ä¸ä»–äººå…±äº«æ•°æ®åº“æ–‡ä»¶</li>
                            </ul>
                        </div>
                    </details>
                </div>
            </div>
        </div>

        <!-- AI ä½¿ç”¨ç»Ÿè®¡ -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ“Š AI ä½¿ç”¨ç»Ÿè®¡</h2>
                <button class="collapse-btn collapsed" onclick="toggleSection('stats')" title="æŠ˜å /å±•å¼€">â–¼</button>
            </div>
            <div class="section-content collapsed" id="statsContent">
            <div id="aiStatsLoading" class="loading">åŠ è½½ä¸­...</div>
            <div id="aiStatsContainer" style="display:none;">
                <div id="aiStatsSummary" style="margin-bottom:20px;"></div>
                <h3 style="margin-bottom:10px;color:#666;">æœ€è¿‘è°ƒç”¨è®°å½•</h3>
                <div id="aiStatsRecent" style="max-height:300px;overflow-y:auto;"></div>
            </div>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="renameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>é‡å‘½åè®¢é˜…æº</h3>
            </div>
            <div class="form-group">
                <label for="renameTitle">æ–°åç§°</label>
                <input type="text" id="renameTitle">
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="submitRename()">ç¡®å®š</button>
                <button class="btn" onclick="closeRenameModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Add Filter Modal -->
    <div id="filterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ è¿‡æ»¤è§„åˆ™</h3>
            </div>
            <div class="form-group">
                <label for="filterType">è¿‡æ»¤ç±»å‹</label>
                <select id="filterType">
                    <option value="include">åŒ…å« (ä»…æ¨é€åŒ¹é…çš„)</option>
                    <option value="exclude">æ’é™¤ (ä¸æ¨é€åŒ¹é…çš„)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filterKeyword">å…³é”®è¯</label>
                <input type="text" id="filterKeyword" placeholder="è¾“å…¥å…³é”®è¯">
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="submitFilter()">æ·»åŠ </button>
                <button class="btn" onclick="closeFilterModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        let currentRenameFeedId = null;
        let currentFilterFeedId = null;
        let feedStatsMap = new Map();

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const result = await response.json();
                if (result.success) {
                    document.getElementById('feedCount').textContent = result.data.feedCount;
                    document.getElementById('articleCount').textContent = result.data.articleCount;
                    document.getElementById('checkInterval').textContent = result.data.checkInterval;
                    document.getElementById('retentionDays').textContent = result.data.retentionDays;
                    document.getElementById('settingInterval').value = result.data.checkInterval;
                    document.getElementById('settingRetentionDays').value = result.data.retentionDays;
                    document.getElementById('settingRetentionCount').value = result.data.retentionCount;

                    // æ›´æ–°æ•°æ®åº“ä¿¡æ¯
                    if (result.data.database) {
                        const db = result.data.database;
                        document.getElementById('dbPath').textContent = db.path || '-';
                        document.getElementById('dbSize').textContent = db.sizeFormatted || '-';
                        document.getElementById('dbFeedCount').textContent = result.data.feedCount;
                        document.getElementById('dbArticleCount').textContent = result.data.articleCount;
                        
                        // æ›´æ–°æ•°æ®åº“çŠ¶æ€å¾½ç« 
                        const badge = document.getElementById('dbStatusBadge');
                        if (db.exists) {
                            badge.textContent = 'æ­£å¸¸';
                            badge.className = 'status-badge status-success';
                        } else {
                            badge.textContent = 'å¼‚å¸¸';
                            badge.className = 'status-badge status-error';
                        }
                    }

                    // ä¿å­˜æ¯ä¸ªæºçš„æ–‡ç« æ•°
                    feedStatsMap.clear();
                    result.data.feedStats.forEach(stat => {
                        feedStatsMap.set(stat.feedId, stat.articleCount);
                    });
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load feeds
        async function loadFeeds() {
            try {
                document.getElementById('feedsLoading').style.display = 'block';
                const response = await fetch('/api/feeds');
                const result = await response.json();

                if (result.success) {
                    const feedsList = document.getElementById('feedsList');
                    feedsList.innerHTML = '';

                    for (const feed of result.data) {
                        const filters = await loadFilters(feed.id);
                        const feedItem = createFeedElement(feed, filters);
                        feedsList.appendChild(feedItem);
                    }
                }
                document.getElementById('feedsLoading').style.display = 'none';
            } catch (error) {
                console.error('Failed to load feeds:', error);
                document.getElementById('feedsLoading').textContent = 'åŠ è½½å¤±è´¥';
            }
        }

        // Load filters for a feed
        async function loadFilters(feedId) {
            try {
                const response = await fetch(`/api/feeds/${feedId}/filters`);
                const result = await response.json();
                return result.success ? result.data : [];
            } catch (error) {
                console.error('Failed to load filters:', error);
                return [];
            }
        }

        // Create feed element
        function createFeedElement(feed, filters) {
            const li = document.createElement('li');
            li.className = 'feed-item' + (feed.error_count > 0 ? ' error' : '');
            li.dataset.feedId = feed.id;

            const articleCount = feedStatsMap.get(feed.id) || 0;

            let filtersHtml = '';
            if (filters.length > 0) {
                filtersHtml = '<div class="filter-list">';
                filters.forEach(filter => {
                    filtersHtml += `<span class="filter-item filter-${filter.type}">${filter.type === 'include' ? 'åŒ…å«' : 'æ’é™¤'}: ${filter.keyword} <a href="#" onclick="deleteFilter(${filter.id}); return false;">Ã—</a></span>`;
                });
                filtersHtml += '</div>';
            }

            li.innerHTML = `
                <div class="feed-header" onclick="toggleFeedDetails(${feed.id})">
                    <div class="feed-title">
                        #${feed.id} ${feed.title || 'æœªå‘½å'}
                        <span class="badge badge-info">${articleCount} ç¯‡æ–‡ç« </span>
                        ${feed.ai_summary_enabled ? '<span class="badge badge-success">ğŸ¤– AI</span>' : ''}
                    </div>
                    <div class="feed-actions" onclick="event.stopPropagation();">
                        <label class="ai-toggle" title="${feed.ai_summary_enabled ? 'ç¦ç”¨ AI æ€»ç»“' : 'å¯ç”¨ AI æ€»ç»“'}">
                            <input type="checkbox" ${feed.ai_summary_enabled ? 'checked' : ''} 
                                   onchange="toggleAISummary(${feed.id}, this.checked)">
                            <span class="ai-toggle-label">AI</span>
                        </label>
                        <button class="btn btn-primary btn-small" onclick="openRenameModal(${feed.id}, '${(feed.title || '').replace(/'/g, "\\'")}')">é‡å‘½å</button>
                        <button class="btn btn-success btn-small" onclick="openFilterModal(${feed.id})">è¿‡æ»¤</button>
                        <button class="btn btn-danger btn-small" onclick="deleteFeed(${feed.id})">åˆ é™¤</button>
                    </div>
                </div>
                <div class="feed-info">é”™è¯¯æ¬¡æ•°: ${feed.error_count} | æœ€åæ£€æŸ¥: ${feed.last_check ? new Date(feed.last_check * 1000).toLocaleString('zh-CN') : 'æœªæ£€æŸ¥'}</div>
                <div class="feed-url">${feed.url}</div>
                ${filtersHtml}
                <div class="feed-details" id="details-${feed.id}">
                    <div id="articles-${feed.id}" class="article-list">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                    <div class="detail-actions">
                        <button class="btn btn-danger btn-small" onclick="clearFeedArticles(${feed.id})">æ¸…ç©ºè¯¥æºçš„æ–‡ç« </button>
                    </div>
                </div>
            `;

            return li;
        }

        // Toggle feed details
        async function toggleFeedDetails(feedId) {
            const detailsDiv = document.getElementById(`details-${feedId}`);
            const feedItem = document.querySelector(`[data-feed-id="${feedId}"]`);

            if (detailsDiv.classList.contains('show')) {
                detailsDiv.classList.remove('show');
                feedItem.classList.remove('expanded');
            } else {
                detailsDiv.classList.add('show');
                feedItem.classList.add('expanded');
                await loadFeedArticles(feedId);
            }
        }

        // Load articles for a feed
        async function loadFeedArticles(feedId) {
            try {
                const articlesDiv = document.getElementById(`articles-${feedId}`);
                articlesDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

                const response = await fetch(`/api/feeds/${feedId}/articles?limit=50`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    if (result.data.length === 0) {
                        articlesDiv.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— æ–‡ç« </div>';
                    } else {
                        articlesDiv.innerHTML = result.data.map(article => `
                            <div class="article-item">
                                <div class="article-title">${article.title || 'æ— æ ‡é¢˜'}</div>
                                <div class="article-date">${new Date(article.published_at * 1000).toLocaleString('zh-CN')}</div>
                            </div>
                        `).join('');
                    }
                } else {
                    articlesDiv.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${result.error}</div>`;
                }
            } catch (error) {
                console.error('Failed to load articles:', error);
                const articlesDiv = document.getElementById(`articles-${feedId}`);
                if (articlesDiv) {
                    articlesDiv.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                }
            }
        }

        // Clear feed articles
        async function clearFeedArticles(feedId) {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºè¯¥è®¢é˜…æºçš„æ‰€æœ‰æ–‡ç« å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/feeds/${feedId}/articles`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    alert(`å·²æ¸…ç† ${result.deletedCount} ç¯‡æ–‡ç« `);
                    await loadFeedArticles(feedId);
                    loadStats();
                } else {
                    alert('æ¸…ç†å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('æ¸…ç†å¤±è´¥: ' + error.message);
            }
        }

        // Add feed
        // æŠ˜å /å±•å¼€æ¨¡å—
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const btn = event.target;
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                btn.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                btn.classList.add('collapsed');
            }
        }

        // æ’åºè®¢é˜…æº
        function sortFeeds() {
            const sortValue = document.getElementById('feedSort').value;
            const feedsList = document.getElementById('feedsList');
            const items = Array.from(feedsList.children);
            
            items.sort((a, b) => {
                const [field, order] = sortValue.split('-');
                let aVal, bVal;
                
                if (field === 'id') {
                    aVal = parseInt(a.dataset.feedId);
                    bVal = parseInt(b.dataset.feedId);
                } else if (field === 'title') {
                    aVal = a.querySelector('.feed-title').textContent.toLowerCase();
                    bVal = b.querySelector('.feed-title').textContent.toLowerCase();
                } else if (field === 'articles') {
                    const aBadge = a.querySelector('.badge-info');
                    const bBadge = b.querySelector('.badge-info');
                    aVal = aBadge ? parseInt(aBadge.textContent) : 0;
                    bVal = bBadge ? parseInt(bBadge.textContent) : 0;
                }
                
                if (order === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            feedsList.innerHTML = '';
            items.forEach(item => feedsList.appendChild(item));
        }

        // æŠ˜å /å±•å¼€æ¨¡å—
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const btn = event.target;
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                btn.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                btn.classList.add('collapsed');
            }
        }

        // æ’åºè®¢é˜…æº
        function sortFeeds() {
            const sortValue = document.getElementById('feedSort').value;
            const feedsList = document.getElementById('feedsList');
            const items = Array.from(feedsList.children);
            
            items.sort((a, b) => {
                const [field, order] = sortValue.split('-');
                let aVal, bVal;
                
                if (field === 'id') {
                    aVal = parseInt(a.dataset.feedId);
                    bVal = parseInt(b.dataset.feedId);
                } else if (field === 'title') {
                    aVal = a.querySelector('.feed-title').textContent.toLowerCase();
                    bVal = b.querySelector('.feed-title').textContent.toLowerCase();
                } else if (field === 'articles') {
                    const aBadge = a.querySelector('.badge-info');
                    const bBadge = b.querySelector('.badge-info');
                    aVal = aBadge ? parseInt(aBadge.textContent) : 0;
                    bVal = bBadge ? parseInt(bBadge.textContent) : 0;
                }
                
                if (order === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            feedsList.innerHTML = '';
            items.forEach(item => feedsList.appendChild(item));
        }

        // é¢„è§ˆRSSæº
        async function previewFeed() {
            const url = document.getElementById('feedUrl').value.trim();
            if (!url) {
                showMessage('addMessage', 'è¯·è¾“å…¥ RSS é“¾æ¥', 'error');
                return;
            }

            const previewResult = document.getElementById('previewResult');
            previewResult.style.display = 'none';
            showMessage('addMessage', 'ğŸ” æ­£åœ¨åŠ è½½é¢„è§ˆ...', 'info');

            try {
                const response = await fetch('/api/feeds/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                
                // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
                if (!response.ok) {
                    const result = await response.json();
                    showMessage('addMessage', 'âŒ ' + (result.error || 'é¢„è§ˆå¤±è´¥'), 'error');
                    return;
                }
                
                const result = await response.json();

                if (result.success) {
                    document.getElementById('previewTitle').textContent = result.data.title;
                    document.getElementById('previewCount').textContent = result.data.articles.length;
                    
                    const articlesList = document.getElementById('previewArticles');
                    articlesList.innerHTML = result.data.articles.map(article => 
                        `<li style="margin-bottom:5px;"><a href="${article.link}" target="_blank" style="color:#667eea;text-decoration:none;">${article.title}</a></li>`
                    ).join('');
                    
                    previewResult.style.display = 'block';
                    showMessage('addMessage', 'âœ… é¢„è§ˆåŠ è½½æˆåŠŸ', 'success');
                } else {
                    showMessage('addMessage', 'âŒ ' + result.error, 'error');
                }
            } catch (error) {
                console.error('é¢„è§ˆé”™è¯¯:', error);
                let errorMsg = 'é¢„è§ˆå¤±è´¥';
                
                if (error.message === 'Failed to fetch') {
                    errorMsg = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿æœåŠ¡æ­£åœ¨è¿è¡Œ (http://localhost:3000)';
                } else if (error.name === 'TypeError') {
                    errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                } else {
                    errorMsg += ': ' + error.message;
                }
                
                showMessage('addMessage', 'âŒ ' + errorMsg, 'error');
            }
        }

        // æ›´æ–°åˆå§‹åŒ–æ¨¡å¼æç¤º
        function updateInitModeHint() {
            const initMode = document.getElementById('initMode').value;
            const hint = document.getElementById('initModeHint');
            
            if (initMode === 'record') {
                hint.textContent = 'ğŸ’¾ ä»…è®°å½•æ–‡ç« åˆ°æ•°æ®åº“ï¼Œä¸ä¼šæ¨é€åˆ° Telegram';
            } else {
                const count = initMode.split('-')[1];
                hint.textContent = `ğŸ’¡ æ¨é€æ¨¡å¼ä¼šç«‹å³å‘é€æœ€æ–° ${count} ç¯‡æ–‡ç« åˆ° Telegram`;
            }
        }

        async function addFeed() {
            const url = document.getElementById('feedUrl').value.trim();
            if (!url) {
                showMessage('addMessage', 'è¯·è¾“å…¥ RSS é“¾æ¥', 'error');
                return;
            }

            const initMode = document.getElementById('initMode').value;
            const pushLatest = initMode !== 'record';
            const pushCount = pushLatest ? parseInt(initMode.split('-')[1]) : 0;
            const enableAI = document.getElementById('enableAI').checked;

            try {
                const response = await fetch('/api/feeds', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, pushLatest, pushCount, enableAI })
                });
                const result = await response.json();

                if (result.success) {
                    const message = result.data.pushed 
                        ? `âœ… æ·»åŠ æˆåŠŸ: ${result.data.title} (å·²æ¨é€ ${result.data.articleCount} ç¯‡æœ€æ–°æ–‡ç« )` 
                        : `âœ… æ·»åŠ æˆåŠŸ: ${result.data.title} (å·²è®°å½• ${result.data.articleCount} ç¯‡æ–‡ç« )`;
                    showMessage('addMessage', message, 'success');
                    document.getElementById('feedUrl').value = '';
                    document.getElementById('initMode').value = 'push-5';
                    document.getElementById('enableAI').checked = false;
                    document.getElementById('previewResult').style.display = 'none';
                    updateInitModeHint();
                    loadFeeds();
                    loadStats();
                } else {
                    showMessage('addMessage', 'âŒ ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('addMessage', 'âŒ æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Delete feed
        async function deleteFeed(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢é˜…æºå—?')) return;

            try {
                const response = await fetch(`/api/feeds/${id}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    loadFeeds();
                    loadStats();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // Rename modal
        function openRenameModal(id, title) {
            currentRenameFeedId = id;
            document.getElementById('renameTitle').value = title;
            document.getElementById('renameModal').classList.add('active');
        }

        function closeRenameModal() {
            document.getElementById('renameModal').classList.remove('active');
        }

        async function submitRename() {
            const title = document.getElementById('renameTitle').value.trim();
            if (!title) return;

            try {
                const response = await fetch(`/api/feeds/${currentRenameFeedId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });
                const result = await response.json();

                if (result.success) {
                    closeRenameModal();
                    loadFeeds();
                } else {
                    alert('é‡å‘½åå¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('é‡å‘½åå¤±è´¥: ' + error.message);
            }
        }

        // Filter modal
        function openFilterModal(id) {
            currentFilterFeedId = id;
            document.getElementById('filterKeyword').value = '';
            document.getElementById('filterModal').classList.add('active');
        }

        function closeFilterModal() {
            document.getElementById('filterModal').classList.remove('active');
        }

        async function submitFilter() {
            const type = document.getElementById('filterType').value;
            const keyword = document.getElementById('filterKeyword').value.trim();

            if (!keyword) return;

            try {
                const response = await fetch('/api/filters', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedId: currentFilterFeedId, type, keyword })
                });
                const result = await response.json();

                if (result.success) {
                    closeFilterModal();
                    loadFeeds();
                } else {
                    alert('æ·»åŠ è¿‡æ»¤è§„åˆ™å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                alert('æ·»åŠ è¿‡æ»¤è§„åˆ™å¤±è´¥: ' + error.message);
            }
        }

        // Delete filter
        async function deleteFilter(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¿‡æ»¤è§„åˆ™å—?')) return;

            try {
                const response = await fetch(`/api/filters/${id}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    loadFeeds();
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // Save settings
        async function saveSettings() {
            const checkInterval = parseInt(document.getElementById('settingInterval').value);
            const retentionDays = parseInt(document.getElementById('settingRetentionDays').value);
            const retentionCount = parseInt(document.getElementById('settingRetentionCount').value);

            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ checkInterval, retentionDays, retentionCount })
                });
                const result = await response.json();

                if (result.success) {
                    showMessage('settingsMessage', 'âœ… è®¾ç½®å·²ä¿å­˜ (éœ€è¦é‡å¯æœåŠ¡ç”Ÿæ•ˆ)', 'success');
                    loadStats();
                } else {
                    showMessage('settingsMessage', 'âŒ ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('settingsMessage', 'âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Manual check
        async function manualCheck() {
            if (!confirm('ç¡®å®šè¦æ‰‹åŠ¨æ£€æŸ¥æ‰€æœ‰è®¢é˜…æºæ›´æ–°å—?')) return;

            showMessage('settingsMessage', 'â³ æ£€æŸ¥ä¸­...', 'success');
            try {
                const response = await fetch('/api/check', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showMessage('settingsMessage', `âœ… æ£€æŸ¥å®Œæˆ: ${result.data.successCount} æˆåŠŸ, ${result.data.failCount} å¤±è´¥`, 'success');
                    loadFeeds();
                    loadStats();
                }
            } catch (error) {
                showMessage('settingsMessage', 'âŒ æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Cleanup by days
        async function cleanupByDays() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ—§æ–‡ç« å—? (æŒ‰å¤©æ•°)')) return;

            try {
                const response = await fetch('/api/cleanup/days', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showMessage('settingsMessage', `âœ… å·²æ¸…ç† ${result.deletedCount} ç¯‡æ–‡ç« `, 'success');
                    loadStats();
                }
            } catch (error) {
                showMessage('settingsMessage', 'âŒ æ¸…ç†å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Cleanup by count
        async function cleanupByCount() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ—§æ–‡ç« å—? (æŒ‰æ•°é‡)')) return;

            try {
                const response = await fetch('/api/cleanup/count', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showMessage('settingsMessage', `âœ… å·²æ¸…ç† ${result.deletedCount} ç¯‡æ–‡ç« `, 'success');
                    loadStats();
                }
            } catch (error) {
                showMessage('settingsMessage', 'âŒ æ¸…ç†å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Show message
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="message message-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Toggle AI summary for feed
        async function toggleAISummary(feedId, enabled) {
            try {
                const response = await fetch(`/api/feeds/${feedId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ aiSummaryEnabled: enabled })
                });
                const result = await response.json();

                if (result.success) {
                    loadFeeds();
                    // æ›´æ–° AI çŠ¶æ€å¡ç‰‡
                    loadAISettings();
                } else {
                    alert('è®¾ç½®å¤±è´¥: ' + result.error);
                    // æ¢å¤å¼€å…³çŠ¶æ€
                    event.target.checked = !enabled;
                }
            } catch (error) {
                alert('è®¾ç½®å¤±è´¥: ' + error.message);
                // æ¢å¤å¼€å…³çŠ¶æ€
                event.target.checked = !enabled;
            }
        }

        // Load AI settings
        async function loadAISettings() {
            try {
                const response = await fetch('/api/ai-settings');
                const result = await response.json();
                if (result.success) {
                    document.getElementById('aiEnabled').checked = result.data.enabled;
                    document.getElementById('aiProvider').value = result.data.provider;
                    if (result.data.apiKey && !result.data.apiKey.startsWith('***')) {
                        document.getElementById('aiApiKey').value = result.data.apiKey;
                    }
                    document.getElementById('aiModel').value = result.data.model || '';
                    document.getElementById('aiMinArticles').value = result.data.minArticles || 3;
                    
                    // æ›´æ–°çŠ¶æ€å¡ç‰‡
                    updateAIStatusCard(result.data);
                    
                    // æ›´æ–° API Key ä¿¡æ¯æ˜¾ç¤º
                    updateApiKeyInfo(result.data.apiKey, result.data.provider);
                }
            } catch (error) {
                console.error('Failed to load AI settings:', error);
            }
        }

        // Update API Key info display
        function updateApiKeyInfo(apiKey, provider) {
            const keyInfo = document.getElementById('aiKeyInfo');
            if (apiKey && apiKey.startsWith('***')) {
                const lastFour = apiKey.slice(-4);
                keyInfo.textContent = `å·²é…ç½® (****${lastFour})`;
                keyInfo.style.color = '#10b981';
            } else if (apiKey) {
                keyInfo.textContent = `å·²è¾“å…¥ (æœªä¿å­˜)`;
                keyInfo.style.color = '#f59e0b';
            } else {
                keyInfo.textContent = 'æœªé…ç½® API Key';
                keyInfo.style.color = '#ef4444';
            }
        }

        // Toggle API Key visibility
        function toggleApiKeyVisibility() {
            const input = document.getElementById('aiApiKey');
            const btn = document.getElementById('toggleKeyBtn');
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'ğŸ™ˆ';
                btn.title = 'éšè—';
            } else {
                input.type = 'password';
                btn.textContent = 'ğŸ‘ï¸';
                btn.title = 'æ˜¾ç¤º';
            }
        }

        // Clear API Key
        function clearApiKey() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ API Key å—ï¼Ÿ')) {
                document.getElementById('aiApiKey').value = '';
                updateApiKeyInfo('', document.getElementById('aiProvider').value);
            }
        }

        // Provider change handler
        async function onProviderChange() {
            const provider = document.getElementById('aiProvider').value;
            const helpDiv = document.getElementById('apiKeyHelp');
            const helpContent = document.getElementById('helpContent');
            
            // å…ˆä¿å­˜æä¾›å•†é€‰æ‹©
            try {
                await fetch('/api/ai-settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider })
                });
                // ç„¶åé‡æ–°åŠ è½½å¯¹åº”æä¾›å•†çš„é…ç½®
                await loadAISettings();
            } catch (error) {
                console.error('Failed to update provider:', error);
            }
            
            const helpTexts = {
                'gemini': `
                    <p><strong>Google Gemini API Key è·å–æ­¥éª¤:</strong></p>
                    <ol style="margin:10px 0;padding-left:20px;">
                        <li>è®¿é—® <a href="https://aistudio.google.com/apikey" target="_blank" style="color:#667eea;">Google AI Studio</a></li>
                        <li>ä½¿ç”¨ Google è´¦å·ç™»å½•</li>
                        <li>ç‚¹å‡» "Create API Key" æŒ‰é’®</li>
                        <li>å¤åˆ¶ç”Ÿæˆçš„ API Key å¹¶ç²˜è´´åˆ°ä¸Šæ–¹è¾“å…¥æ¡†</li>
                    </ol>
                    <p style="color:#666;font-size:13px;">ğŸ’¡ Gemini API ç›®å‰å…è´¹ä½¿ç”¨ï¼Œæ¯åˆ†é’Ÿæœ€å¤š 60 ä¸ªè¯·æ±‚</p>
                `,
                'deepseek': `
                    <p><strong>DeepSeek API Key è·å–æ­¥éª¤:</strong></p>
                    <ol style="margin:10px 0;padding-left:20px;">
                        <li>è®¿é—® <a href="https://platform.deepseek.com" target="_blank" style="color:#667eea;">DeepSeek å¹³å°</a></li>
                        <li>æ³¨å†Œå¹¶ç™»å½•è´¦å·</li>
                        <li>è¿›å…¥ API Keys é¡µé¢</li>
                        <li>åˆ›å»ºæ–°çš„ API Key</li>
                        <li>å¤åˆ¶ Key å¹¶ç²˜è´´åˆ°ä¸Šæ–¹è¾“å…¥æ¡†</li>
                    </ol>
                    <p style="color:#666;font-size:13px;">ğŸ’° DeepSeek å®šä»·: è¾“å…¥ Â¥1/M tokens, è¾“å‡º Â¥2/M tokens</p>
                `,
                'qwen': `
                    <p><strong>é€šä¹‰åƒé—® API Key è·å–æ­¥éª¤:</strong></p>
                    <ol style="margin:10px 0;padding-left:20px;">
                        <li>è®¿é—® <a href="https://dashscope.aliyun.com" target="_blank" style="color:#667eea;">é˜¿é‡Œäº‘ DashScope</a></li>
                        <li>ä½¿ç”¨é˜¿é‡Œäº‘è´¦å·ç™»å½•</li>
                        <li>è¿›å…¥ API-KEY ç®¡ç†é¡µé¢</li>
                        <li>åˆ›å»ºæ–°çš„ API Key</li>
                        <li>å¤åˆ¶ Key å¹¶ç²˜è´´åˆ°ä¸Šæ–¹è¾“å…¥æ¡†</li>
                    </ol>
                    <p style="color:#666;font-size:13px;">ğŸ’° åƒé—®å®šä»·: è¾“å…¥ Â¥0.5/M tokens, è¾“å‡º Â¥2/M tokens</p>
                `
            };
            
            helpContent.innerHTML = helpTexts[provider] || '';
            helpDiv.style.display = 'block';
            
            // æ›´æ–°æ¨¡å‹æç¤º
            const modelHints = {
                'gemini': 'Gemini: gemini-2.0-flash-exp (æ¨è) | gemini-pro',
                'deepseek': 'DeepSeek: deepseek-chat (æ¨è)',
                'qwen': 'åƒé—®: qwen-turbo (æ¨è) | qwen-plus | qwen-max'
            };
            document.getElementById('aiModelHint').textContent = modelHints[provider] || '';
        }

        // Test AI connection
        async function testAIConnection() {
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('aiApiKey').value.trim();
            const model = document.getElementById('aiModel').value.trim();
            
            if (!apiKey || apiKey.startsWith('***')) {
                showMessage('aiMessage', 'âš ï¸ è¯·å…ˆè¾“å…¥ API Key', 'error');
                return;
            }
            
            const testBtn = document.getElementById('testAIBtn');
            const originalText = testBtn.textContent;
            testBtn.disabled = true;
            testBtn.textContent = 'â³ æµ‹è¯•ä¸­...';
            
            try {
                // å…ˆä¿å­˜è®¾ç½®
                const saveResponse = await fetch('/api/ai-settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: true, provider, apiKey, model })
                });
                
                if (!saveResponse.ok) {
                    throw new Error('ä¿å­˜è®¾ç½®å¤±è´¥');
                }
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„æµ‹è¯• API è°ƒç”¨
                // ç”±äºæˆ‘ä»¬æ²¡æœ‰ä¸“é—¨çš„æµ‹è¯•ç«¯ç‚¹ï¼Œæš‚æ—¶åªæ£€æŸ¥ä¿å­˜æ˜¯å¦æˆåŠŸ
                showMessage('aiMessage', 'âœ… API Key å·²ä¿å­˜ï¼Œå°†åœ¨ä¸‹æ¬¡ RSS æ£€æŸ¥æ—¶æµ‹è¯•å®é™…è¿æ¥', 'success');
                loadAISettings();
            } catch (error) {
                showMessage('aiMessage', 'âŒ æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            }
        }

        // Update AI status card
        async function updateAIStatusCard(aiSettings) {
            // è·å–å·²å¯ç”¨ AI çš„è®¢é˜…æºæ•°é‡
            let enabledFeedsCount = 0;
            try {
                const feedsResponse = await fetch('/api/feeds');
                const feedsResult = await feedsResponse.json();
                if (feedsResult.success) {
                    enabledFeedsCount = feedsResult.data.filter(f => f.ai_summary_enabled === 1).length;
                }
            } catch (error) {
                console.error('Failed to count enabled feeds:', error);
            }

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const hasApiKey = aiSettings.apiKey && aiSettings.apiKey !== '';
            const isGlobalEnabled = aiSettings.enabled;
            
            // å…¨å±€çŠ¶æ€
            document.getElementById('aiGlobalStatus').textContent = isGlobalEnabled ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨';
            
            // æä¾›å•†
            const providerNames = {
                'gemini': 'Google Gemini',
                'deepseek': 'DeepSeek',
                'qwen': 'é€šä¹‰åƒé—®'
            };
            document.getElementById('aiProviderStatus').textContent = providerNames[aiSettings.provider] || aiSettings.provider;
            
            // API Key çŠ¶æ€
            document.getElementById('aiKeyStatus').textContent = hasApiKey ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®';
            
            // å·²å¯ç”¨æºæ•°
            document.getElementById('aiEnabledFeedsCount').textContent = `${enabledFeedsCount} ä¸ª`;
            
            // æ•´ä½“çŠ¶æ€å¾½ç« 
            const statusBadge = document.getElementById('aiStatusBadge');
            if (isGlobalEnabled && hasApiKey && enabledFeedsCount > 0) {
                statusBadge.textContent = 'âœ… å·²é…ç½®';
                statusBadge.className = 'status-badge status-configured';
            } else if (hasApiKey && (isGlobalEnabled || enabledFeedsCount > 0)) {
                statusBadge.textContent = 'âš ï¸ éƒ¨åˆ†é…ç½®';
                statusBadge.className = 'status-badge status-partial';
            } else {
                statusBadge.textContent = 'âŒ æœªé…ç½®';
                statusBadge.className = 'status-badge status-unconfigured';
            }
        }

        // Save AI settings
        async function saveAISettings() {
            const enabled = document.getElementById('aiEnabled').checked;
            const provider = document.getElementById('aiProvider').value;
            const apiKey = document.getElementById('aiApiKey').value.trim();
            const model = document.getElementById('aiModel').value.trim();
            const minArticles = parseInt(document.getElementById('aiMinArticles').value) || 3;

            try {
                const response = await fetch('/api/ai-settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled, provider, apiKey, model, minArticles })
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage('aiMessage', 'âœ… AI è®¾ç½®å·²ä¿å­˜', 'success');
                    loadAISettings(); // é‡æ–°åŠ è½½ä»¥æ›´æ–°çŠ¶æ€å¡ç‰‡
                    loadAIStats();
                } else {
                    showMessage('aiMessage', 'âŒ ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('aiMessage', 'âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Load AI stats
        async function loadAIStats() {
            try {
                document.getElementById('aiStatsLoading').style.display = 'block';
                document.getElementById('aiStatsContainer').style.display = 'none';
                
                const response = await fetch('/api/ai-stats?days=30');
                const result = await response.json();
                
                if (result.success) {
                    const { summary, recentCalls } = result.data;
                    
                    // æ˜¾ç¤ºæ±‡æ€»ç»Ÿè®¡
                    let summaryHtml = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">';
                    
                    if (summary.length === 0) {
                        summaryHtml = '<p style="text-align:center;color:#999;">æš‚æ— ä½¿ç”¨è®°å½•</p>';
                    } else {
                        summary.forEach(stat => {
                            const currency = stat.provider === 'gemini' ? 'USD' : 'CNY';
                            summaryHtml += `
                                <div style="background:#f9fafb;padding:15px;border-radius:8px;">
                                    <div style="font-weight:600;color:#333;margin-bottom:10px;">${stat.provider.toUpperCase()}</div>
                                    <div style="font-size:13px;color:#666;margin-bottom:5px;">è°ƒç”¨æ¬¡æ•°: ${stat.call_count}</div>
                                    <div style="font-size:13px;color:#666;margin-bottom:5px;">è¾“å…¥ Token: ${stat.total_input_tokens.toLocaleString()}</div>
                                    <div style="font-size:13px;color:#666;margin-bottom:5px;">è¾“å‡º Token: ${stat.total_output_tokens.toLocaleString()}</div>
                                    <div style="font-size:13px;color:#666;margin-bottom:5px;">æ€» Token: ${stat.total_tokens.toLocaleString()}</div>
                                    <div style="font-size:14px;color:#10b981;font-weight:600;">æˆæœ¬: ${stat.total_cost.toFixed(4)} ${currency}</div>
                                    <div style="font-size:12px;color:#888;margin-top:5px;">æ€»æ–‡ç« æ•°: ${stat.total_articles}</div>
                                </div>
                            `;
                        });
                    }
                    summaryHtml += '</div>';
                    document.getElementById('aiStatsSummary').innerHTML = summaryHtml;
                    
                    // æ˜¾ç¤ºæœ€è¿‘è°ƒç”¨è®°å½•
                    let recentHtml = '';
                    if (recentCalls.length === 0) {
                        recentHtml = '<p style="text-align:center;color:#999;">æš‚æ— è°ƒç”¨è®°å½•</p>';
                    } else {
                        recentCalls.forEach(call => {
                            const date = new Date(call.created_at * 1000).toLocaleString('zh-CN');
                            const currency = call.provider === 'gemini' ? 'USD' : 'CNY';
                            recentHtml += `
                                <div style="background:#f9fafb;padding:10px;margin-bottom:8px;border-radius:5px;font-size:13px;">
                                    <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                                        <span style="font-weight:600;color:#333;">${call.provider} / ${call.model}</span>
                                        <span style="color:#888;">${date}</span>
                                    </div>
                                    <div style="color:#666;">
                                        Token: ${call.input_tokens}/${call.output_tokens}/${call.total_tokens} | 
                                        æˆæœ¬: ${call.estimated_cost.toFixed(6)} ${currency} | 
                                        æ–‡ç« : ${call.article_count} ç¯‡
                                    </div>
                                </div>
                            `;
                        });
                    }
                    document.getElementById('aiStatsRecent').innerHTML = recentHtml;
                    
                    document.getElementById('aiStatsLoading').style.display = 'none';
                    document.getElementById('aiStatsContainer').style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load AI stats:', error);
                document.getElementById('aiStatsLoading').textContent = 'åŠ è½½å¤±è´¥';
            }
        }

        // Initialize
        loadStats();
        loadFeeds();
        loadAISettings();
        loadAIStats();
        updateInitModeHint();
        setInterval(loadStats, 30000); // Refresh stats every 30 seconds
        setInterval(loadAIStats, 60000); // Refresh AI stats every 60 seconds
    </script>
</body>

</html>